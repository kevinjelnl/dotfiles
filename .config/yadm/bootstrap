#!/bin/bash

# Save this file as ~/.config/yadm/bootstrap and make it executable. It will
# execute all executable files (excluding templates and editor backups) in the
# ~/.config/yadm/bootstrap.d directory when run.

set -eu
# define the operating system
system_type="$(uname -s)"
default_bootstrap_file=false
ran=false

# Directory to look for bootstrap executables in
BOOTSTRAP_D="${BASH_SOURCE[0]}.d"

if [[ ! -d "$BOOTSTRAP_D" ]]; then
    echo "Error: bootstrap directory '$BOOTSTRAP_D' not found" >&2
    exit 1
fi

exec_bootstrap() {
    echo "...bootstrapping device with file: $1"
    bash $1
    if [[ $? -eq 0 ]]; then ran="true"; return 0
    else 
        echo "Issues during bootstrapping with file: $1"; return 1
    fi
}

# Test if a Bootstrap file is found for the current operating system
if [[ -n $(find -L "$BOOTSTRAP_D" -type f -name "bootstrap_os.$system_type") ]]; then
    exec_bootstrap "$(find -L "$BOOTSTRAP_D" -type f -name "bootstrap_os.$system_type")"
else
    # No bootstrap file found for the current operating system use the default one if present
    if [[ -n $(find -L "$BOOTSTRAP_D" -type f -name "bootstrap_os.default") ]]; then
        exec_bootstrap "$(find -L "$BOOTSTRAP_D" -type f -name "bootstrap_os.default")"
    else
        echo "Error: No bootstrap file found for the current operating system, nor a default one" >&2
        exit 1
    fi
fi

